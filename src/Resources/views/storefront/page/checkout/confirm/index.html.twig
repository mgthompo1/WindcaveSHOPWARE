{% sw_extends '@Storefront/storefront/page/checkout/confirm/index.html.twig' %}

{# Inject Windcave scripts in the head based on payment mode #}
{% block base_head %}
    {{ parent() }}

    {% if page.extensions.windcaveDropIn and page.extensions.windcaveDropIn.links is not empty %}
        {% set windcaveData = page.extensions.windcaveDropIn %}
        {% set paymentMode = windcaveData.paymentMode|default('dropin') %}

        {% if paymentMode == 'hostedfields' %}
            {# Hosted Fields only needs the hosted fields script #}
            <script src="{{ windcaveData.scriptBase }}/js/lib/hosted-fields-v1.js"></script>
            <script src="{{ windcaveData.scriptBase }}/js/windcavepayments-hostedfields-v1.js"></script>
        {% elseif paymentMode == 'dropin' %}
            {# Load Windcave Drop-In JavaScript files - order matters! #}
            <script src="{{ windcaveData.scriptBase }}/js/lib/drop-in-v1.js"></script>
            <script src="{{ windcaveData.scriptBase }}/js/windcavepayments-dropin-v1.js"></script>
            <script src="{{ windcaveData.scriptBase }}/js/lib/hosted-fields-v1.js"></script>
            <script src="{{ windcaveData.scriptBase }}/js/windcavepayments-hostedfields-v1.js"></script>
            {# Apple Pay and Google Pay scripts - always load them, SDK checks availability #}
            <script src="{{ windcaveData.scriptBase }}/js/windcavepayments-applepay-v1.js"></script>
            <script src="{{ windcaveData.scriptBase }}/js/windcavepayments-googlepay-v1.js"></script>
        {% endif %}

        {# Custom CSS from admin configuration #}
        {% if windcaveData.customCss %}
        <style>
            {{ windcaveData.customCss|raw }}
        </style>
        {% endif %}

        <style>
            {% if paymentMode == 'hostedfields' %}
            /* ========================================
               Hosted Fields - Clean Card Form
               ======================================== */
            .windcave-hosted-fields {
                padding: 0;
            }

            /* Labels row */
            .windcave-hf-labels {
                display: flex;
                gap: 8px;
                margin-bottom: 6px;
                font-size: 12px;
                font-weight: 500;
                color: #6b7280;
            }
            .windcave-hf-labels .hf-label-card { flex: 1; }
            .windcave-hf-labels .hf-label-expiry { width: 80px; text-align: center; }
            .windcave-hf-labels .hf-label-cvv { width: 64px; text-align: center; }
            .windcave-hf-labels .hf-label-zip { width: 80px; text-align: center; }

            /* Fields row */
            .windcave-hf-fields {
                display: flex;
                gap: 8px;
            }

            /* Field containers */
            .windcave-hf-card { flex: 1; min-width: 0; }
            .windcave-hf-expiry { width: 80px; flex-shrink: 0; }
            .windcave-hf-cvv { width: 64px; flex-shrink: 0; }
            .windcave-hf-zip { width: 80px; flex-shrink: 0; }

            /* Input container */
            .windcave-hf-input {
                height: 44px;
                background: #fff;
                border: 1px solid #dee2e6;
                border-radius: 0.375rem;
                overflow: hidden;
                position: relative;
            }
            .windcave-hf-input:focus-within {
                border-color: #0d6efd;
                box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
            }

            /* Iframe - fill container exactly */
            .windcave-hf-input iframe {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                border: none !important;
            }

            /* Error */
            .windcave-hf-error {
                color: #dc3545;
                font-size: 13px;
                margin-top: 10px;
                display: none;
            }

            /* Secure note */
            .windcave-secure-note {
                margin-top: 12px;
                font-size: 11px;
                color: #6c757d;
            }

            {% elseif paymentMode == 'dropin' %}
            /* ========================================
               Drop-In - Embedded Payment UI
               ======================================== */
            .windcave-dropin-wrapper {
                margin-top: 0;
            }
            .windcave-dropin-container {
                min-height: 150px;
            }
            .windcave-dropin-container .windcave-loading {
                padding: 32px;
                text-align: center;
                color: #6c757d;
                font-size: 13px;
            }

            /* Hide Windcave's "Select Payment Method" title */
            .windcave-dropin-container .wc-select-payment-method-text,
            .windcave-dropin-container .wc-payment-method-title {
                display: none !important;
            }

            /* Clean container */
            .windcave-dropin-container .wc-drop-in-container {
                padding: 0 !important;
                margin: 0 !important;
            }

            /* Payment method items */
            .windcave-dropin-container .wc-item-group {
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                background: transparent !important;
            }
            .windcave-dropin-container .wc-item-group-item {
                border: 1px solid #dee2e6 !important;
                border-radius: 0.375rem !important;
                margin-bottom: 8px !important;
                background: #fff !important;
            }

            /* Card inputs */
            .windcave-dropin-container .wc-card-input,
            .windcave-dropin-container .wc-card-input-container {
                border: 1px solid #dee2e6 !important;
                border-radius: 0.375rem !important;
            }

            /* Submit button - match Shopware primary button */
            .windcave-dropin-container .wc-card-submit-button,
            .windcave-dropin-container .wc-redirect-button {
                background-color: #0d6efd !important;
                border-color: #0d6efd !important;
                color: #fff !important;
                border-radius: 0.375rem !important;
                font-weight: 500 !important;
                padding: 12px 24px !important;
                width: 100% !important;
                margin-top: 12px !important;
            }

            /* Hide Shopware's submit button - Drop-In has its own Pay button */
            .checkout-aside-action {
                display: none !important;
            }
            {% endif %}
        </style>
    {% endif %}
{% endblock %}

{# Extend the payment block to replace Shopware's payment UI with Windcave #}
{% block page_checkout_confirm_payment %}
    {% if page.extensions.windcaveDropIn and page.extensions.windcaveDropIn.links is not empty %}
        {% set windcaveData = page.extensions.windcaveDropIn %}
        {% set paymentMode = windcaveData.paymentMode|default('dropin') %}
        {% set requireZip = windcaveData.requireZipCode|default(false) %}

        {# Wrap in same structure as Shopware's payment card #}
        <div class="col-sm-6 confirm-payment">
            <div class="card checkout-card">
                <div class="card-body">
                    {% if paymentMode == 'hostedfields' %}
                        {# Hosted Fields - Clean inline card form #}
                        <div class="windcave-hosted-fields">
                            <div class="card-title">Payment method</div>
                            <div id="windcave-hosted-fields-form">
                                {# Labels row #}
                                <div class="windcave-hf-labels">
                                    <span class="hf-label-card">Card number</span>
                                    <span class="hf-label-expiry">Expiry</span>
                                    <span class="hf-label-cvv">CVC</span>
                                    {% if requireZip %}<span class="hf-label-zip">ZIP</span>{% endif %}
                                </div>
                                {# Fields row #}
                                <div class="windcave-hf-fields">
                                    <div class="windcave-hf-card">
                                        <div id="windcave-card-number" class="windcave-hf-input"></div>
                                    </div>
                                    <div class="windcave-hf-expiry">
                                        <div id="windcave-expiry-date" class="windcave-hf-input"></div>
                                    </div>
                                    <div class="windcave-hf-cvv">
                                        <div id="windcave-cvv" class="windcave-hf-input"></div>
                                    </div>
                                    {% if requireZip %}
                                    <div class="windcave-hf-zip">
                                        <div id="windcave-postal-code" class="windcave-hf-input"></div>
                                    </div>
                                    {% endif %}
                                </div>
                                <div id="windcave-hf-error" class="windcave-hf-error"></div>
                            </div>
                            <p class="windcave-secure-note">Secured by Windcave</p>
                            <input type="hidden" id="windcave-payment-completed" name="windcavePaymentCompleted" value="0" form="confirmOrderForm">
                            <input type="hidden" id="windcave-session-id" name="windcaveSessionId" value="{{ windcaveData.sessionId }}" form="confirmOrderForm">
                        </div>
                    {% elseif paymentMode == 'dropin' %}
                        {# Drop-In container #}
                        <div class="card-title">Payment method</div>
                        <div class="windcave-dropin-wrapper">
                            <div id="windcave-dropin-container" class="windcave-dropin-container">
                                <p class="windcave-loading">Loading secure payment form...</p>
                            </div>
                            <input type="hidden" id="windcave-payment-completed" name="windcavePaymentCompleted" value="0" form="confirmOrderForm">
                            <input type="hidden" id="windcave-session-id" name="windcaveSessionId" value="{{ windcaveData.sessionId }}" form="confirmOrderForm">
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    {% else %}
        {# No Windcave session - show default Shopware payment UI #}
        {{ parent() }}
    {% endif %}
{% endblock %}

{# JavaScript initialization in body script block #}
{% block base_body_script %}
    {{ parent() }}

    {% if page.extensions.windcaveDropIn and page.extensions.windcaveDropIn.links is not empty %}
        {% set windcaveData = page.extensions.windcaveDropIn %}
        {% set paymentMode = windcaveData.paymentMode|default('dropin') %}
        {% set requireZip = windcaveData.requireZipCode|default(false) %}

        {% if paymentMode == 'hostedfields' %}
        <script>
            (function() {
                var config = {
                    sessionId: "{{ windcaveData.sessionId }}",
                    links: {{ windcaveData.links|json_encode|raw }},
                    requireZip: {{ requireZip ? 'true' : 'false' }}
                };

                console.log('=== Windcave Hosted Fields Config ===');
                console.log('Session ID:', config.sessionId);
                console.log('Links:', config.links);
                console.log('Require ZIP:', config.requireZip);

                var instance = null;
                var paymentCompleted = false;

                // Find the ajaxSubmitCard link for form submission
                var cardLink = null;
                for (var i = 0; i < config.links.length; i++) {
                    if (config.links[i].rel === 'ajaxSubmitCard') {
                        cardLink = config.links[i].href;
                        break;
                    }
                }
                console.log('Card submit URL:', cardLink);

                function showError(message) {
                    var errorDiv = document.getElementById('windcave-hf-error');
                    if (errorDiv) {
                        errorDiv.textContent = message;
                        errorDiv.style.display = 'block';
                    }
                }

                function hideError() {
                    var errorDiv = document.getElementById('windcave-hf-error');
                    if (errorDiv) {
                        errorDiv.textContent = '';
                        errorDiv.style.display = 'none';
                    }
                }

                function initHostedFields() {
                    console.log('Initializing Windcave Hosted Fields...');

                    if (!cardLink) {
                        showError('Payment configuration error. Please try again.');
                        return;
                    }

                    var fields = {
                        CardNumber: {
                            container: 'windcave-card-number',
                            placeholder: '1234 5678 9012 3456',
                            tabOrder: 1,
                            cardSchemaImagePlacement: 'right',
                            supportedCards: ['visa', 'masterCard', 'amex'],
                            length: {
                                maximumValidLength: 19,
                                jumpToNextField: true
                            }
                        },
                        ExpirationDate: {
                            container: 'windcave-expiry-date',
                            placeholder: 'MM/YY',
                            tabOrder: 2,
                            length: {
                                jumpToNextField: true
                            }
                        },
                        CVV: {
                            container: 'windcave-cvv',
                            placeholder: 'CVC',
                            tabOrder: 3,
                            length: {
                                jumpToNextField: true
                            }
                        }
                    };

                    // Add postal code field if required
                    if (config.requireZip) {
                        fields.BillingPostalCode = {
                            container: 'windcave-postal-code',
                            placeholder: 'ZIP',
                            tabOrder: 4,
                            length: {
                                jumpToNextField: true
                            }
                        };
                    }

                    var options = {
                        sessionId: config.sessionId,
                        formId: 'windcave-hosted-fields-form',
                        fields: fields,
                        styles: {
                            'input': {
                                'font-family': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
                                'font-size': '14px',
                                'color': '#212529',
                                'padding': '0 10px',
                                'height': '42px',
                                'line-height': '42px',
                                'box-sizing': 'border-box',
                                'background': 'transparent',
                                'border': 'none',
                                'outline': 'none',
                                'width': '100%'
                            },
                            'input::placeholder': {
                                'color': '#adb5bd'
                            },
                            'input:focus': {
                                'outline': 'none'
                            }
                        }
                    };

                    try {
                        instance = WindcavePayments.HostedFields.create(
                            options,
                            10000,
                            function() {
                                console.log('Hosted Fields created successfully!');
                                window.windcaveAjaxUrl = cardLink;
                            },
                            function(err) {
                                console.error('Hosted Fields creation failed:', err);
                                showError('Failed to load payment form. Please refresh the page.');
                            }
                        );
                        window.windcaveHostedFields = instance;
                    } catch (e) {
                        console.error('Exception creating Hosted Fields:', e);
                        showError('Payment form error. Please refresh the page.');
                    }
                }

                function waitForWindcave() {
                    var maxAttempts = 100;
                    var attempts = 0;

                    function check() {
                        attempts++;
                        var container = document.getElementById('windcave-card-number');
                        var sdkReady = window.WindcavePayments && window.WindcavePayments.HostedFields;

                        if (sdkReady && container) {
                            console.log('WindcavePayments SDK and container ready (attempt ' + attempts + ')');
                            initHostedFields();
                        } else if (attempts < maxAttempts) {
                            setTimeout(check, 100);
                        } else {
                            console.error('WindcavePayments SDK or container failed to load');
                            showError('Payment form unavailable. Please refresh the page.');
                        }
                    }
                    check();
                }

                // Intercept form submission to submit via Hosted Fields
                document.addEventListener('DOMContentLoaded', function() {
                    var orderForm = document.getElementById('confirmOrderForm');
                    if (orderForm) {
                        orderForm.addEventListener('submit', function(e) {
                            var paymentCompletedField = document.getElementById('windcave-payment-completed');

                            // If payment already completed, allow form submission
                            if (paymentCompletedField && paymentCompletedField.value === '1') {
                                console.log('Payment completed, allowing order submission');
                                return true;
                            }

                            // Check TOS
                            var tosCheckbox = document.getElementById('tos');
                            if (tosCheckbox && !tosCheckbox.checked) {
                                // Let Shopware handle TOS validation
                                return true;
                            }

                            // Prevent default and submit via Hosted Fields
                            e.preventDefault();
                            hideError();

                            if (!instance) {
                                showError('Payment form not ready. Please wait and try again.');
                                return false;
                            }

                            var submitUrl = window.windcaveAjaxUrl;
                            if (!submitUrl) {
                                showError('Payment configuration error.');
                                return false;
                            }

                            console.log('Submitting payment via Hosted Fields...');

                            // Disable submit button
                            var submitBtn = document.getElementById('confirmFormSubmit');
                            if (submitBtn) {
                                submitBtn.disabled = true;
                                submitBtn.textContent = 'Processing...';
                            }

                            instance.submit(
                                submitUrl,
                                30000,
                                function(status) {
                                    console.log('Hosted Fields submit status:', status);

                                    if (status === '3DSecure') {
                                        // 3DS in progress - SDK handles the redirect/iframe
                                        console.log('3DSecure authentication in progress...');
                                        return;
                                    }

                                    if (status === 'done') {
                                        // Payment completed successfully
                                        paymentCompleted = true;
                                        document.getElementById('windcave-payment-completed').value = '1';
                                        console.log('Payment completed, submitting order...');
                                        orderForm.submit();
                                    } else {
                                        // Unknown status - log and show error
                                        console.warn('Unexpected status:', status);
                                        showError('Payment could not be completed. Please try again.');
                                        if (submitBtn) {
                                            submitBtn.disabled = false;
                                            submitBtn.textContent = 'Submit order';
                                        }
                                    }
                                },
                                function(err) {
                                    console.error('Hosted Fields submit error:', err);
                                    var errorMsg = 'Payment failed. Please check your card details and try again.';
                                    if (err && typeof err === 'object' && err.message) {
                                        errorMsg = err.message;
                                    } else if (typeof err === 'string') {
                                        errorMsg = err;
                                    }
                                    showError(errorMsg);
                                    if (submitBtn) {
                                        submitBtn.disabled = false;
                                        submitBtn.textContent = 'Submit order';
                                    }
                                }
                            );

                            return false;
                        });
                    }
                });

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', waitForWindcave);
                } else {
                    waitForWindcave();
                }
            })();
        </script>
        {% elseif paymentMode == 'dropin' %}
        <script>
            (function() {
                var windcaveConfig = {
                    sessionId: "{{ windcaveData.sessionId }}",
                    links: {{ windcaveData.links|json_encode|raw }},
                    totalValue: "{{ windcaveData.totalValue }}",
                    currency: "{{ windcaveData.currency }}",
                    country: "{{ windcaveData.country }}",
                    merchantName: "{{ windcaveData.merchantName }}",
                    isTest: {{ windcaveData.isTest ? 'true' : 'false' }},
                    appleMerchantId: "{{ windcaveData.appleMerchantId|default('') }}",
                    googleMerchantId: "{{ windcaveData.googleMerchantId|default('') }}",
                    darkModeConfig: "{{ windcaveData.darkModeConfig|default('light') }}",
                    hideSelectPaymentMethodTitle: {{ windcaveData.hideSelectPaymentMethodTitle ? 'true' : 'false' }},
                    styles: {{ windcaveData.styles|json_encode|raw }}
                };

                console.log('=== Windcave Inline Drop-In Config ===');
                console.log('Session ID:', windcaveConfig.sessionId);
                console.log('Links count:', windcaveConfig.links.length);

                var paymentCompleted = false;
                var windcaveDropIn = null;

                function initDropIn() {
                    console.log('Initializing Windcave Drop-In on checkout page...');

                    var options = {
                        container: 'windcave-dropin-container',
                        links: windcaveConfig.links,
                        totalValue: windcaveConfig.totalValue,
                        darkModeConfig: windcaveConfig.darkModeConfig,
                        hideSelectPaymentMethodTitle: true,
                        card: {
                            supportedCards: ['visa', 'mastercard', 'amex'],
                            sideIcons: ['visa', 'mastercard', 'amex']
                        },
                        onSuccess: function(status) {
                            console.log('Windcave payment success, status:', status);

                            if (status === '3DSecure') {
                                console.log('3DS in progress, waiting...');
                                return;
                            }

                            paymentCompleted = true;
                            document.getElementById('windcave-payment-completed').value = '1';

                            console.log('Payment completed, submitting order form...');

                            var orderForm = document.getElementById('confirmOrderForm');
                            if (orderForm) {
                                orderForm.submit();
                            }
                        },
                        onError: function(stage, error) {
                            console.error('Windcave payment error:', stage, error);

                            var container = document.getElementById('windcave-dropin-container');
                            if (container) {
                                var errorDiv = document.createElement('div');
                                errorDiv.className = 'alert alert-danger mt-3';
                                errorDiv.innerHTML = '<strong>Payment Error:</strong> ' +
                                    (error && error.message ? error.message : 'An error occurred during payment. Please try again.');
                                container.appendChild(errorDiv);
                            }
                        },
                        onPaymentStart: function(paymentMethod, next, cancel) {
                            console.log('Payment starting with method:', paymentMethod);

                            var tosCheckbox = document.getElementById('tos');
                            if (tosCheckbox && !tosCheckbox.checked) {
                                alert('Please accept the terms and conditions before proceeding with payment.');
                                cancel();
                                return;
                            }

                            next();
                        }
                    };

                    if (windcaveConfig.appleMerchantId || windcaveConfig.googleMerchantId) {
                        options.mobilePayments = {
                            merchantName: windcaveConfig.merchantName,
                            countryCode: windcaveConfig.country,
                            currencyCode: windcaveConfig.currency,
                            supportedNetworks: ['visa', 'mastercard', 'amex'],
                            isTest: windcaveConfig.isTest
                        };

                        if (windcaveConfig.appleMerchantId) {
                            options.mobilePayments.applePay = {
                                merchantId: windcaveConfig.appleMerchantId
                            };
                        }

                        if (windcaveConfig.googleMerchantId) {
                            options.mobilePayments.googlePay = {
                                merchantId: windcaveConfig.googleMerchantId,
                                googleMerchantId: windcaveConfig.isTest ? '00000000' : windcaveConfig.googleMerchantId
                            };
                        }
                    }

                    if (windcaveConfig.styles && Object.keys(windcaveConfig.styles).length > 0) {
                        options.styles = windcaveConfig.styles;
                    }

                    try {
                        windcaveDropIn = WindcavePayments.DropIn.create(
                            options,
                            function onCreateSuccess() {
                                console.log('Windcave Drop-In created successfully on checkout page!');
                                // Hide the default submit button - payment is done via Drop-In Pay button
                                var submitBtn = document.getElementById('confirmFormSubmit');
                                if (submitBtn) {
                                    submitBtn.style.display = 'none';
                                    console.log('Windcave: Hidden submit button');
                                }
                            },
                            function onCreateError(err) {
                                console.error('Windcave Drop-In creation failed:', err);
                                document.getElementById('windcave-dropin-container').innerHTML =
                                    '<div class="alert alert-warning">' +
                                    '<strong>Payment form unavailable.</strong> ' +
                                    'You can still proceed with checkout - you will be redirected to complete payment.' +
                                    '</div>';
                            }
                        );

                        window.windcaveDropIn = windcaveDropIn;
                    } catch (e) {
                        console.error('Exception creating Drop-In:', e);
                    }
                }

                function waitForWindcave() {
                    var maxAttempts = 100;
                    var attempts = 0;

                    function check() {
                        attempts++;
                        var container = document.getElementById('windcave-dropin-container');
                        var sdkReady = window.WindcavePayments && window.WindcavePayments.DropIn;

                        if (sdkReady && container) {
                            console.log('WindcavePayments SDK and container ready (attempt ' + attempts + ')');
                            initDropIn();
                        } else if (attempts < maxAttempts) {
                            setTimeout(check, 100);
                        } else {
                            console.error('WindcavePayments SDK or container failed to load');
                            if (container) {
                                container.innerHTML =
                                    '<div class="alert alert-warning">' +
                                    '<strong>Payment form unavailable.</strong> ' +
                                    'You can still proceed with checkout.' +
                                    '</div>';
                            }
                        }
                    }
                    check();
                }

                document.addEventListener('DOMContentLoaded', function() {
                    var orderForm = document.getElementById('confirmOrderForm');
                    if (orderForm) {
                        orderForm.addEventListener('submit', function(e) {
                            var paymentCompletedField = document.getElementById('windcave-payment-completed');

                            if (paymentCompletedField && paymentCompletedField.value === '1') {
                                console.log('Payment completed, allowing order submission');
                                return true;
                            }

                            if (windcaveDropIn && !paymentCompleted) {
                                e.preventDefault();
                                console.log('Payment not completed - please complete payment in the form above');
                                alert('Please complete your payment using the payment form above before placing your order.');
                                return false;
                            }

                            return true;
                        });
                    }
                });

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', waitForWindcave);
                } else {
                    waitForWindcave();
                }
            })();
        </script>
        {% endif %}
    {% endif %}
{% endblock %}
